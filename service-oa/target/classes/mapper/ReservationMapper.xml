<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.hualiang.core.mapper.ReservationMapper">

    <select id="getAllReservation" resultType="Reservation">
        select reservation.*, hotel_name from reservation left join hotel using(hotel_id)
        <where>
            <foreach collection="map" index="key" item="value">
                <if test="key != 'option' and key != 'value'">
                    and reservation.${key} <!-- 限定条件 -->
                    <choose>
                        <when test="value == 'null'">
                            is null
                        </when>
                        <when test="value == 'not null'">
                            is not null
                        </when>
                        <otherwise>
                            = #{value}
                        </otherwise>
                    </choose>
                </if>
            </foreach>
            and ${map.option} <!-- 模糊查询 -->
            <if test="map.value == 'null'">
                is null
            </if>
            <if test="map.value != 'null'">
                like concat('%',#{map.value},'%')
            </if>
        </where>
    </select>

    <!-- List<Reservation> getReservationByMID(Integer mid); -->
    <select id="getReservationByMID" resultType="Reservation">
        select r.*, hotel_name
        from reservation r
                 left join hotel h using (hotel_id)
                 left join user u on h.manager_id = u.uid
        where uid = #{mid}
    </select>

    <!-- List<Integer> getPendingRoomIdByUID(Integer uid); -->
    <select id="getPendingRoomIdByUID" resultType="Integer">
        select room_id
        from reservation
        where user_id = #{uid}
          and status is null
    </select>

    <select id="getUserReservationByUID" resultType="Reservation">
        select re.*, h.hotel_name, r.type
        from reservation re
                 LEFT JOIN hotel h ON re.hotel_id = h.hotel_id
                 LEFT JOIN room r ON re.room_id = r.room_id
        where re.user_id = #{uid}
    </select>

    <select id="getDetail" resultType="ReservationDetail">
        SELECT re.*, h.hotel_name, h.address, r.size, r.price, r.num_of_guests, r.type
        FROM reservation re
                 LEFT JOIN hotel h ON re.hotel_id = h.hotel_id
                 LEFT JOIN room r ON re.room_id = r.room_id
        WHERE re.id = #{orderId}
    </select>


</mapper>